<!DOCTYPE html>
<html>
<head>
<title>Johans enhörningsdatabas</title>
<meta charset="UTF-8">
<style type="text/css">
table {
  border-spacing: 10px;
  border-collapse: separate;
  cellspacing: 100px;
  width: 1200px;
}
td {
  border: 1px solid black;
  padding: 10px;
}
li {
  cursor: pointer;
}
#unicornImage img {
  max-width: 800px;
}
#list {
  width: 300px;
}
label {
  display: inline-block;
  width: 150px;
}
form {
  padding: 10px;
}
</style>
</head>
<body>
<h1>Johans enhörningsdatabas</h1>
<table>
  <tr>
    <td id="list">
      <ul id="unicorns">
        <li><a href="">Enhörning 1</a></li>
        <li><a href="">Enhörning 2</a></li>
        <li><a href="">Enhörning 3</a></li>
      </ul>
    </td>
    <td id="info">
      <h2 id="unicornName">Ingen enhörning</h2>
      <span id="unicornImage"></span>
      <p id="unicornInfo"></p>
      <p id="unicornSighting"></p>
      <button type="button" id="addUnicorn">Lägg till enhörning</button>
      <button type="button" id="updateUnicorn">Uppdatera enhörning</button>
      <button type="button" id="deleteUnicorn">Ta bort enhörning</button>

      <form name="existingUnicorn" id="existingUnicorn">
        <input type="hidden" name="id">
        <label for="name">Enhörningens namn</label>
        <input type="text" name="name"><br>
        <label for="reportedBy">Vem såg den?</label>
        <input type="text" name="reportedBy"><br>
        <label for="spottedWhere.name">Var sågs den?</label>
        <input type="text" name="spottedWhere.name"><br>
        <label for="spottedWhere.lat">Latitud</label>
        <input type="text" name="spottedWhere.lat"><br>
        <label for="spottedWhere.lon">Longitud</label>
        <input type="text" name="spottedWhere.lon"><br>
        <label for="spottedWhen">När sågs den?</label>
        <input type="date" name="spottedWhen"><br>
        <label for="image">Bild</label>
        <input type="text" name="image"><br>
        <label for="description">Beskrivning</label>
        <textarea name="description"></textarea><br>
        <button type="button" id="putUnicorn">Skicka</button>
      </form>

      <form name="newUnicorn" id="newUnicorn">
        <input type="hidden" name="id">
        <label for="name">Enhörningens namn</label>
        <input type="text" name="name"><br>
        <label for="reportedBy">Vem såg den?</label>
        <input type="text" name="reportedBy"><br>
        <label for="spottedWhere.name">Var sågs den?</label>
        <input type="text" name="spottedWhere.name"><br>
        <label for="spottedWhere.lat">Latitud</label>
        <input type="text" name="spottedWhere.lat"><br>
        <label for="spottedWhere.lon">Longitud</label>
        <input type="text" name="spottedWhere.lon"><br>
        <label for="spottedWhen">När sågs den?</label>
        <input type="date" name="spottedWhen"><br>
        <label for="image">Bild</label>
        <input type="text" name="image"><br>
        <label for="description">Beskrivning</label>
        <textarea name="description"></textarea><br>
        <button type="button" id="postUnicorn">Skicka</button>
      </form>
    </td>
  </tr>
</table>
<script type="text/javascript">
const baseURL = "http://unicorns.idioti.se/";

async function listUnicorns() {
  const options = {
    method: "GET",
    headers: {
      "Accept": "application/json"
    }
  };
  const response = await fetch(baseURL, options);
  const unicorns = await response.json();
  const unicornList = document.querySelector("#unicorns");
  unicornList.replaceChildren();
  unicorns.forEach((unicorn) => {
    let listItem = document.createElement("li");
    listItem.setAttribute("name", "unicorn_" + unicorn.id);
    listItem.setAttribute("value", unicorn.id);
    listItem.innerHTML = unicorn.name;
    listItem.addEventListener("click", fetchThenDisplayUnicorn);
    unicornList.appendChild(listItem);
  });
}

async function fetchThenDisplayUnicorn(event) {
  const url = baseURL + event.target.value;
  const options = {
    method: "GET",
    headers: {
      "Accept": "application/json"
    }
  };
  const response = await fetch(url, options);
  const unicorn = await response.json();
  displayUnicorn(unicorn);
}

function displayUnicorn(unicorn) {
  const date = new Date(unicorn.spottedWhen);
  const legibleDate = date.toLocaleString("sv-SE", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });
  const sighting = `Av: ${unicorn.reportedBy}, ${legibleDate} i ${unicorn.spottedWhere.name}`;
  const image = document.createElement("img");
  image.setAttribute("src", unicorn.image);
  
  document.querySelector("#unicornName").innerHTML = unicorn.name;
  document.querySelector("#unicornImage").replaceChildren(image);
  document.querySelector("#unicornInfo").innerHTML = unicorn.description;
  document.querySelector("#unicornSighting").innerHTML = sighting;
  
  document.querySelector("#existingUnicorn input[name=id]").value = unicorn.id;
  document.querySelector("#existingUnicorn input[name=name]").value = unicorn.name;
  document.querySelector("#existingUnicorn input[name=reportedBy]").value = unicorn.reportedBy;
  document.querySelector("#existingUnicorn input[name='spottedWhere.name']").value = unicorn.spottedWhere.name;
  document.querySelector("#existingUnicorn input[name='spottedWhere.lat']").value = unicorn.spottedWhere.lat;
  document.querySelector("#existingUnicorn input[name='spottedWhere.lon']").value = unicorn.spottedWhere.lon;
  document.querySelector("#existingUnicorn input[name=spottedWhen]").value = legibleDate;
  document.querySelector("#existingUnicorn input[name=image]").value = unicorn.image;
  document.querySelector("#existingUnicorn [name=description]").value = unicorn.description;
  hideForms();
}

async function postUnicorn() {
  /*
   * Skapa en ny enhörning genom att läsa in värdena från formuläret
   */
  const unicorn = {};
  unicorn.name = document.querySelector("#newUnicorn input[name=name]").value;
  unicorn.description = document.querySelector("#newUnicorn [name=description]").value;
  unicorn.reportedBy = document.querySelector("#newUnicorn input[name=reportedBy]").value;
  /*
   * spottedWhere är ett nästlat objekt
   */
  unicorn.spottedWhere = {
    name: document.querySelector("#newUnicorn input[name='spottedWhere.name']").value,
    lat: document.querySelector("#newUnicorn input[name='spottedWhere.lat']").value,
    lon: document.querySelector("#newUnicorn input[name='spottedWhere.lon']").value
  };
  /*
   * Datumformatet matchar inte det som webbtjänsten vill ha. Fixa till det.
   */
  unicorn.spottedWhen = document.querySelector(`#newUnicorn input[name=spottedWhen]`).value + " 00:00:00";
  unicorn.image = document.querySelector(`#newUnicorn input[name=image]`).value;
  
  /*
   * POST-anrop med JSON-innehåll
   */
  const options = {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(unicorn)
  };
  
  /*
   * Skicka enhörningen till webbtjänsten
   */
  await fetch(baseURL, options);
  /*
   * Dölj formulären
   */
  hideForms();
}

function hideForms() {
  document.querySelectorAll("form").forEach((form) => {
    form.style.display = "none";
  });
}

function showAddForm() {
  hideForms();
  document.querySelector("#newUnicorn").style.display = "block";
}

function showUpdateForm() {
  hideForms();
  document.querySelector("#existingUnicorn").style.display = "block";
}

document.querySelector("#addUnicorn").addEventListener("click", showAddForm);
document.querySelector("#updateUnicorn").addEventListener("click", showUpdateForm);
document.querySelector("#postUnicorn").addEventListener("click", postUnicorn);
hideForms();
listUnicorns();
</script>
</body>
</html>
